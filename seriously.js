define("seriously",function(){"use strict";function e(t,i){let r,s;t.prototype&&i.prototype&&t.prototype!==i.prototype&&e(t.prototype,i.prototype);for(r in i)i.hasOwnProperty(r)&&((s=Object.getOwnPropertyDescriptor(i,r)).get||s.set?Object.defineProperty(t,r,{configurable:!0,enumerable:!0,get:s.get,set:s.set}):t[r]=i[r]);return t}function t(e){return Array.isArray(e)||e&&e.BYTES_PER_ELEMENT&&"length"in e}function i(e,t,i,r,s){function n(e,t,i){return(i%=1)<0&&(i+=1),i<1/6?e+(t-e)*i*6:i<.5?t:i<2/3?e+(t-e)*(2/3-i)*6:e}let o,h;return h=i<.5?i*(t+1):i+t-i*t,o=2*i-h,s||(s=[]),s[0]=n(o,h,e+1/3),s[1]=n(o,h,e),s[2]=n(o,h,e-1/3),s[3]=r,s}function r(e){let t,i,r,s="#",n=e[3]<1?4:3;for(t=0;t<n;t++)r=(i=Math.min(255,Math.round(255*e[t]||0))).toString(16),i<16&&(r="0"+r),s+=r;return s}function s(){}function n(e){let t;if(!X)return s;if("function"==typeof X[e])t=X[e];else{if("function"!=typeof X.log)return s;t=X.log}return t.bind?t.bind(X):function(){t.apply(X,arguments)}}function o(e,t){let i,r;if("string"==typeof e)i=W.querySelector(e);else if(!e)return!1;return e.tagName&&(i=e),i?(r=i.tagName.toLowerCase(),t&&t.indexOf(r)<0?e:i):e}function h(e,t){if(t||(t="HTMLElement"),e instanceof window[t])return!0;if(!e||"object"!=typeof e)return!1;for(;e;)if((e=Object.getPrototypeOf(e))&&e.constructor.name===t)return!0;return!1}function u(e){if("function"!=typeof e)throw new Error("setTimeoutZero argument is not a function");V.push(e),"file:"!==window.location.protocol?window.postMessage("seriously-timeout-message",window.location):setTimeout(function(){V.length&&V.shift()()},0)}function a(e,t){let i;try{i=window.WebGLDebugUtils&&t&&t.debugContext?window.WebGLDebugUtils.makeDebugContext(e.getContext("webgl",t)):e.getContext("webgl",t)}catch(e){}if(!i)try{i=e.getContext("experimental-webgl",t)}catch(e){}return i}function l(e){let t;return q&&q.getError()===q.CONTEXT_LOST_WEBGL&&(q=void 0),q||!window.WebGLRenderingContext||e?q:(t=W.createElement("canvas"),(q=a(t))?t.addEventListener("webglcontextlost",function e(i){i.preventDefault(),q&&q.canvas===this&&(q=void 0,t.removeEventListener("webglcontextlost",e,!1))},!1):j.warn("Unable to access WebGL."),q)}function f(e,t){var i,r,s,n;if(!(i=o(e,K)))return!1;if(!(r=Z.createElement("canvas")))return j.warn("Browser does not support canvas or Seriously.js"),!1;if(0===i.naturalWidth&&"IMG"===i.tagName)return j.warn("Image not loaded"),!1;if(0===i.readyState&&0===i.videoWidth&&"VIDEO"===i.tagName)return j.warn("Video not loaded"),!1;if(s=l(t)){(n=s.createTexture())||j.error("Test WebGL context has been lost"),s.bindTexture(s.TEXTURE_2D,n);try{s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,i)}catch(e){return e.code===window.DOMException.SECURITY_ERR?j.log("Unable to access cross-domain image"):j.error("Error storing image to texture: "+e.message),s.deleteTexture(n),!1}s.deleteTexture(n)}else{s=r.getContext("2d");try{s.drawImage(i,0,0),s.getImageData(0,0,1,1)}catch(e){return e.code===window.DOMException.SECURITY_ERR?j.log("Unable to access cross-domain image"):j.error("Error drawing image to canvas: "+e.message),!1}}return!0}function c(e,t){let i,r,s;return!!t&&(i=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,e.vertices,t.STATIC_DRAW),i.size=3,r=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,r),t.bufferData(t.ELEMENT_ARRAY_BUFFER,e.indices,t.STATIC_DRAW),s=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,s),t.bufferData(t.ARRAY_BUFFER,e.coords,t.STATIC_DRAW),s.size=2,{vertex:i,index:r,texCoord:s,length:e.indices.length,mode:e.mode||t.TRIANGLES})}function d(e){return c({vertices:new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0]),indices:new Uint16Array([0,1,2,0,2,3]),coords:new Float32Array([0,0,1,0,1,1,0,1])},e)}function p(e,t,i,r){let s,n,o,h,u=!0===r?r:r&&r.useFloat;u=!1,this.type=e.UNSIGNED_BYTE,s=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,s),r&&r.texture?(this.texture=r.texture,e.bindTexture(e.TEXTURE_2D,this.texture),this.ownTexture=!1):(this.texture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.texture),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),this.ownTexture=!0);try{this.type===e.FLOAT?(o=new Float32Array(t*i*4),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t,i,0,e.RGBA,e.FLOAT,o)):(e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t,i,0,e.RGBA,e.UNSIGNED_BYTE,null),this.type=e.UNSIGNED_BYTE)}catch(r){this.type=e.UNSIGNED_BYTE,o=new Uint8Array(t*i*4),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t,i,0,e.RGBA,e.UNSIGNED_BYTE,o)}if(n=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,n),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,t,i),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,n),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.texture,0),(h=e.checkFramebufferStatus(e.FRAMEBUFFER))===e.FRAMEBUFFER_INCOMPLETE_ATTACHMENT)throw new Error("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");if(h===e.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT)throw new Error("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");if(h===e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS)throw new Error("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");if(h===e.FRAMEBUFFER_UNSUPPORTED)throw new Error("Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED");if(h!==e.FRAMEBUFFER_COMPLETE)throw new Error("Incomplete framebuffer: "+h);e.bindTexture(e.TEXTURE_2D,null),e.bindRenderbuffer(e.RENDERBUFFER,null),e.bindFramebuffer(e.FRAMEBUFFER,null),this.gl=e,this.frameBuffer=s,this.renderBuffer=n,this.width=t,this.height=i}function m(e,t,i){function r(t,i){let r;if(r=i?e.createShader(e.FRAGMENT_SHADER):e.createShader(e.VERTEX_SHADER),e.shaderSource(r,t),e.compileShader(r),!e.getShaderParameter(r,e.COMPILE_STATUS)){t=t.split(/[\n\r]/);for(let e=0;e<t.length;e++)t[e]=e+1+":\t"+t[e];throw t.unshift("Error compiling "+(i?"fragment":"vertex")+" shader:"),j.error(t.join("\n")),new Error("Shader error: "+e.getShaderInfoLog(r))}return r}let s,n,o,h,u,a,l,f,c="";if(n=r(t),o=r(i,!0),s=e.createProgram(),e.attachShader(s,n),(h=e.getShaderInfoLog(n))&&(c+="Vertex shader error: "+h+"\n"),e.attachShader(s,o),(h=e.getShaderInfoLog(o))&&(c+="Fragment shader error: "+h+"\n"),e.linkProgram(s),!e.getProgramParameter(s,e.LINK_STATUS))throw c+=e.getProgramInfoLog(s),e.deleteProgram(s),e.deleteShader(n),e.deleteShader(o),(l=B.exec(t)||B.exec(i))&&(c="Shader = "+l[1]+"\n"+c),U.forEach(function(t){c+="\n"+t+": "+e.getParameter(e[t])}),new Error("Could not initialize shader:\n"+c);for(e.useProgram(s),this.uniforms={},a=e.getProgramParameter(s,e.ACTIVE_UNIFORMS),u=0;u<a;++u)(f={info:e.getActiveUniform(s,u)}).name=f.info.name.replace(/\[0\]$/,""),f.loc=e.getUniformLocation(s,f.name),f.set=function(t,i){if(t.type===e.SAMPLER_2D)return function(r){t.glTexture=e["TEXTURE"+r],e.uniform1i(i,r)};if(t.type===e.BOOL||t.type===e.INT)return t.size>1?function(t){e.uniform1iv(i,t)}:function(t){e.uniform1i(i,t)};if(t.type===e.FLOAT)return t.size>1?function(t){e.uniform1fv(i,t)}:function(t){e.uniform1f(i,t)};if(t.type===e.FLOAT_VEC2)return function(t){e.uniform2f(i,t[0],t[1])};if(t.type===e.FLOAT_VEC3)return function(t){e.uniform3f(i,t[0],t[1],t[2])};if(t.type===e.FLOAT_VEC4)return function(t){e.uniform4f(i,t[0],t[1],t[2],t[3])};if(t.type===e.FLOAT_MAT3)return function(t){e.uniformMatrix3fv(i,!1,t)};if(t.type===e.FLOAT_MAT4)return function(t){e.uniformMatrix4fv(i,!1,t)};throw new Error("Unknown shader uniform type: "+t.type)}(f.info,f.loc),f.get=function(t){return function(){return e.getUniform(s,t)}}(f.loc),this.uniforms[f.name]=f,this[f.name]||(this[f.name]=f);for(this.attributes={},this.location={},a=e.getProgramParameter(s,e.ACTIVE_ATTRIBUTES),u=0;u<a;++u)(f={info:e.getActiveAttrib(s,u)}).name=f.info.name,f.location=e.getAttribLocation(s,f.name),this.attributes[f.name]=f,this.location[f.name]=f.location;this.gl=e,this.program=s,this.destroy=function(){e&&(e.deleteProgram(s),e.deleteShader(n),e.deleteShader(o));for(let e in this)this.hasOwnProperty(e)&&delete this[e];s=null,n=null,o=null}}function g(e){this.ready=!1,this.width=1,this.height=1,this.uniforms={resolution:[this.width,this.height],transform:null},this.dirty=!0,this.isDestroyed=!1,this.seriously=e,this.gl=e.gl,this.listeners={},this.id=e.getNodeId()}function y(e){let t=e;Object.defineProperties(this,{original:{enumerable:!0,configurable:!0,get:function(){return t.source}},id:{enumerable:!0,configurable:!0,get:function(){return t.id}},width:{enumerable:!0,configurable:!0,get:function(){return t.width}},height:{enumerable:!0,configurable:!0,get:function(){return t.height}}}),this.render=function(){t.render()},this.update=function(){t.update(),t.setDirty()},this.readPixels=function(e,i,r,s,n){return t.readPixels(e,i,r,s,n)},this.on=function(e,i){t.on(e,i)},this.off=function(e,i){t.off(e,i)},this.destroy=function(){let e,i;t.destroy();for(e in this)this.hasOwnProperty(e)&&"isDestroyed"!==e&&"id"!==e&&((i=Object.getOwnPropertyDescriptor(this,e)).get||i.set||"function"!=typeof this[e]?delete this[e]:this[e]=$)},this.isDestroyed=function(){return t.isDestroyed},this.isReady=function(){return t.ready}}function E(e,t,i,r){function s(e){return p.source===e}let n,u,a=r||{},l=void 0===a.flip||a.flip,f=a.width,c=a.height,d=!1,p=this,m=!1;if(g.call(this,e),n=this.seriously.gl,(t&&"string"!=typeof t||!i&&0!==i)&&(r&&"object"==typeof r||(r=i),i=t),"string"==typeof i&&isNaN(i)&&(i=o(i,["canvas","img","video"])),"string"==typeof t&&(u=this.seriously.constructor.sourcePlugin(this,t,i,r,!0))&&(this.hook=t,m=!0,d=u.deferTexture,this.plugin=u,this.compare=u.compare,this.checkDirty=u.checkDirty,u.source&&(i=u.source)),!u&&h(i))"CANVAS"===i.tagName?(this.width=i.width,this.height=i.height,this.render=this.renderImageCanvas.bind(this),m=!0,this.hook="canvas",this.compare=s,this.update=function(){this.width=i.width,this.height=i.height,this.resize()}):"IMG"===i.tagName&&(this.width=i.naturalWidth||1,this.height=i.naturalHeight||1,i.complete&&i.naturalWidth||(d=!0),i.addEventListener("load",function(){p.isDestroyed||(p.width===i.naturalWidth&&p.height===i.naturalHeight||(p.width=i.naturalWidth,p.height=i.naturalHeight,p.resize()),p.setDirty(),p.setReady())},!0),this.render=this.renderImageCanvas.bind(this),m=!0,this.hook="image",this.compare=s);else if(!u&&h(i,"WebGLTexture")){if(n&&!n.isTexture(i))throw new Error("Not a valid WebGL texture.");isNaN(f)?isNaN(c)||(f=c):isNaN(c)&&(c=f),this.width=f,this.height=c,void 0===a.flip&&(l=!1),m=!0,this.texture=i,this.initialized=!0,this.hook="texture",this.compare=s,this.render=function(){}}if(m||u||this.seriously.constructor.forEachSource(function(e,t){if(t=this.seriously.constructor.sourcePlugin(this,e,i,r,!1))return this.hook=e,m=!0,d=t.deferTexture,this.plugin=t,this.compare=t.compare,this.checkDirty=t.checkDirty,t.source&&(i=t.source),!1}.bind(this)),!m)throw new Error("Unknown source type");this.source=i,void 0===this.flip&&(this.flip=l),this.targets=[],d||p.setReady(),this.pub=new y(this),e.addSourceNode(this)}function T(t){function i(e,t){const i=n.effect.inputs[e];let s,u=n.inputElements[e];return"string"==typeof t&&isNaN(t)&&("enum"===i.type?i.options.hasOwnProperty(t)||(t=o(t,["select"])):"number"===i.type||"boolean"===i.type?t=o(t,["input","select"]):"image"===i.type&&(t=o(t,["canvas","img","video"]))),h(t,"HTMLInputElement")||h(t,"HTMLSelectElement")?(s=t.value,u&&u.element!==t&&(u.element.removeEventListener("change",u.listener,!0),u.element.removeEventListener("input",u.listener,!0),delete n.inputElements[e],u=null),u||(u={element:t,listener:function(e,s){return function(){let o,h;o="checkbox"===t.type?t.checked:s.value,h=n.setInput(e,o),"color"===i.type&&(h=r(h).substr(0,7)),h!==o&&(s.value=h)}}(e,t)},n.inputElements[e]=u,"range"===t.type?(t.addEventListener("input",u.listener,!0),t.addEventListener("change",u.listener,!0)):t.addEventListener("change",u.listener,!0)),u&&"checkbox"===t.type&&(s=t.checked)):(u&&(u.element.removeEventListener("change",u.listener,!0),u.element.removeEventListener("input",u.listener,!0),delete n.inputElements[e]),s=t),n.setInput(e,s),n.inputs[e]}let s,n=t;for(s in n.effect.inputs)if(n.effect.inputs.hasOwnProperty(s)){if(void 0!==this[s])throw new Error("Cannot overwrite Seriously."+s);"image"===n.effect.inputs[s].type?Object.defineProperty(this,s,{configurable:!0,enumerable:!0,get:function(e){return function(){let t=n.inputs[e];return t&&t.pub}}(s),set:function(e){return function(t){let r=i(e,t);return r&&r.pub}}(s)}):Object.defineProperty(this,s,{configurable:!0,enumerable:!0,get:function(e){return function(){return n.inputs[e]}}(s),set:function(e){return function(t){return i(e,t)}}(s)})}Object.defineProperties(this,{effect:{enumerable:!0,configurable:!0,get:function(){return n.hook}},title:{enumerable:!0,configurable:!0,get:function(){return n.effect.title||n.hook}},width:{enumerable:!0,configurable:!0,get:function(){return n.width}},height:{enumerable:!0,configurable:!0,get:function(){return n.height}},id:{enumerable:!0,configurable:!0,get:function(){return n.id}}}),this.render=function(){return n.render(),this},this.readPixels=function(e,t,i,r,s){return n.readPixels(e,t,i,r,s)},this.on=function(e,t){n.on(e,t)},this.off=function(e,t){n.off(e,t)},this.inputs=function(t){let i,r,s,o=n.effect.inputs;if(t)return(r=o[t])?(i={type:r.type,defaultValue:r.defaultValue,title:r.title||t},"number"===r.type?(i.min=r.min,i.max=r.max,i.step=r.step,i.mod=r.mod):"enum"===r.type?i.options=e({},r.options):"vector"===r.type&&(i.dimensions=r.dimensions),r.description&&(i.description=r.description),i):null;i={};for(s in o)o.hasOwnProperty(s)&&(i[s]=this.inputs(s));return i},this.alias=function(e,t){return n.alias(e,t),this},this.matte=function(e){n.matte(e)},this.destroy=function(){let e,t;n.destroy();for(e in this)this.hasOwnProperty(e)&&"isDestroyed"!==e&&"id"!==e&&((t=Object.getOwnPropertyDescriptor(this,e)).get||t.set||"function"!=typeof this[e]?delete this[e]:this[e]=J)},this.isDestroyed=function(){return n.isDestroyed},this.isReady=function(){return n.ready}}function w(t,i,r,s){let n,o,h,u,a={};g.call(this,t),this.effectRef=r,this.sources={},this.targets=[],this.inputElements={},this.dirty=!0,this.shaderDirty=!0,this.hook=i,this.options=s,this.transform=null,this.effect=e({},this.effectRef),this.effectRef.definition&&e(this.effect,this.effectRef.definition.call(this,s)),Seriously.validateInputSpecs(this.effect),this.uniforms.transform=k,this.inputs={},u=t.defaults(i);for(n in this.effect.inputs)this.effect.inputs.hasOwnProperty(n)&&(void 0!==(o=this.effect.inputs[n]).defaultValue&&null!==o.defaultValue||("number"===o.type?o.defaultValue=Math.min(Math.max(0,o.min),o.max):"color"===o.type?o.defaultValue=[0,0,0,0]:"boolean"===o.type?o.defaultValue=!1:"string"===o.type?o.defaultValue="":"enum"===o.type&&(o.defaultValue=o.firstValue)),h=o.validate.call(this,o.defaultValue,o),u&&void 0!==u[n]&&(h=o.validate.call(this,u[n],o,o.defaultValue,h),u[n]=h,"image"===o.type&&(a[n]=h)),this.inputs[n]=h,o.uniform&&(this.uniforms[o.uniform]=o.defaultValue));this.seriously.gl&&(this.initialize(),this.effect.commonShader&&this.buildShader()),this.updateReady(),this.inPlace=this.effect.inPlace,this.pub=new T(this),t.addEffectNode(this);for(n in a)a.hasOwnProperty(n)&&this.setInput(n,a[n])}function b(t){function i(e,t,i){let s,u;s=n.inputElements[e],"string"==typeof i&&isNaN(i)&&("enum"===t.type?t.options.hasOwnProperty(i)||(i=o(i,["select"])):"number"===t.type||"boolean"===t.type?i=o(i,["input","select"]):"image"===t.type&&(i=o(i,["canvas","img","video"]))),h(i,"HTMLInputElement")||h(i,"HTMLSelectElement")?(u=i.value,s&&s.element!==i&&(s.element.removeEventListener("change",s.listener,!0),s.element.removeEventListener("input",s.listener,!0),delete n.inputElements[e],s=null),s||(s={element:i,listener:function(t){return function(){let s,o;s="checkbox"===i.type?i.checked:t.value,o=n.setInput(e,s),"color"===i.type&&(o=r(o)),o!==s&&(t.value=o)}}(i)},n.inputElements[e]=s,"range"===i.type?(i.addEventListener("input",s.listener,!0),i.addEventListener("change",s.listener,!0)):i.addEventListener("change",s.listener,!0)),s&&"checkbox"===i.type&&(u=i.checked)):(s&&(s.element.removeEventListener("change",s.listener,!0),s.element.removeEventListener("input",s.listener,!0),delete n.inputElements[e]),u=i),n.setInput(e,u)}let s,n=t,u=this;Object.defineProperties(this,{transform:{enumerable:!0,configurable:!0,get:function(){return n.hook}},title:{enumerable:!0,configurable:!0,get:function(){return n.plugin.title||n.hook}},width:{enumerable:!0,configurable:!0,get:function(){return n.width}},height:{enumerable:!0,configurable:!0,get:function(){return n.height}},id:{enumerable:!0,configurable:!0,get:function(){return n.id}},source:{enumerable:!0,configurable:!0,get:function(){return n.source&&n.source.pub},set:function(e){n.setSource(e)}}});for(s in n.methods)n.methods.hasOwnProperty(s)&&(this[s]=function(e){return function(){e.apply(n,arguments)&&n.setTransformDirty()}}(n.methods[s]));for(s in n.inputs)n.inputs.hasOwnProperty(s)&&function(e,t){Object.defineProperty(u,e,{configurable:!0,enumerable:!0,get:function(){return t.get.call(n)},set:function(r){i(e,t,r)}})}(s,n.inputs[s]);this.update=function(){n.setDirty()},this.inputs=function(t){let i,r,s,o;if(s=n.plugin.inputs,t)return!(r=s[t])||r.method?null:(i={type:r.type,defaultValue:r.defaultValue,title:r.title||t},"number"===r.type?(i.min=r.min,i.max=r.max,i.step=r.step,i.mod=r.mod):"enum"===r.type?i.options=e({},r.options):"vector"===r.type&&(i.dimensions=r.dimensions),r.description&&(i.description=r.description),i);i={};for(o in s)s.hasOwnProperty(o)&&!s[o].method&&(i[o]=this.inputs(o));return i},this.alias=function(e,t){return n.alias(e,t),this},this.on=function(e,t){n.on(e,t)},this.off=function(e,t){n.off(e,t)},this.destroy=function(){let e,t;n.destroy();for(e in this)this.hasOwnProperty(e)&&"isDestroyed"!==e&&"id"!==e&&((t=Object.getOwnPropertyDescriptor(this,e)).get||t.set||"function"!=typeof this[e]?delete this[e]:this[e]=Q)},this.isDestroyed=function(){return n.isDestroyed},this.isReady=function(){return n.ready}}function x(t,i,r,s){let n,o,h,u,a;this.matrix=new Float32Array(16),this.cumulativeMatrix=new Float32Array(16),this.ready=!1,this.width=1,this.height=1,this.seriously=t,this.gl=t.gl,this.transformRef=r,this.hook=i,this.id=t.getNodeId(),this.options=s,this.sources=null,this.targets=[],this.inputElements={},this.inputs={},this.methods={},this.listeners={},this.texture=null,this.frameBuffer=null,this.uniforms=null,this.dirty=!0,this.transformDirty=!0,this.renderDirty=!1,this.isDestroyed=!1,this.transformed=!1,this.plugin=e({},this.transformRef),this.transformRef.definition&&e(this.plugin,this.transformRef.definition.call(this,s));for(n in this.plugin.inputs)this.plugin.inputs.hasOwnProperty(n)&&((o=this.plugin.inputs[n]).method&&"function"==typeof o.method?this.methods[n]=o.method:"function"==typeof o.set&&"function"==typeof o.get&&(this.inputs[n]=o));Seriously.validateInputSpecs(this.plugin),a=t.defaults(i);for(n in this.plugin.inputs)this.plugin.inputs.hasOwnProperty(n)&&"function"==typeof(o=this.plugin.inputs[n]).set&&"function"==typeof o.get&&"function"!=typeof o.method&&(h=o.get.call(this),u=void 0===o.defaultValue?h:o.defaultValue,u=o.validate.call(this,u,o,h),a&&void 0!==a[n]&&(u=o.validate.call(this,a[n],o,o.defaultValue,u),a[n]=u),u!==h&&o.set.call(this,u));this.pub=new b(this),t.addTransformNode(this)}function v(e){let t=e;Object.defineProperties(this,{source:{enumerable:!0,configurable:!0,get:function(){if(t.source)return t.source.pub},set:function(e){t.setSource(e)}},original:{enumerable:!0,configurable:!0,get:function(){return t.target}},width:{enumerable:!0,configurable:!0,get:function(){return t.width},set:function(e){!isNaN(e)&&e>0&&t.width!==e&&(t.width=e,t.resize(),t.setTransformDirty())}},height:{enumerable:!0,configurable:!0,get:function(){return t.height},set:function(e){!isNaN(e)&&e>0&&t.height!==e&&(t.height=e,t.resize(),t.setTransformDirty())}},id:{enumerable:!0,configurable:!0,get:function(){return t.id}}}),this.render=function(){t.render()},this.readPixels=function(e,i,r,s,n){return t.readPixels(e,i,r,s,n)},this.on=function(e,i){t.on(e,i)},this.off=function(e,i){t.off(e,i)},this.go=function(e){t.go(e)},this.stop=function(){t.stop()},this.getTexture=function(){return t.frameBuffer.texture},this.destroy=function(){let e,i;t.destroy();for(e in this)this.hasOwnProperty(e)&&"isDestroyed"!==e&&"id"!==e&&((i=Object.getOwnPropertyDescriptor(this,e)).get||i.set||"function"!=typeof this[e]?delete this[e]:this[e]=ee)},this.inputs=function(e){return{source:{type:"image"}}},this.isDestroyed=function(){return t.isDestroyed},this.isReady=function(){return t.ready}}function R(t,i,r,s){function n(i,r,s,n){let o=t.getTarget(i);if(o.definition){if(!(o=o.definition.call(b,r,s,n)))return null;o=e(e({},t.getTarget(i)),o),b.hook=w,x=!0,b.plugin=o,b.compare=o.compare,o.target&&(r=o.target),o.gl&&!b.gl&&(b.gl=o.gl,t.gl||t.attachContext(o.gl)),b.gl===t.gl&&(b.model=t.rectangleModel,b.shader=t.baseShader)}return o}let o,u,l,f,c,y,E,T,w,b=this,x=!1;if(g.call(this,t),c=t.gl,(i&&"string"!=typeof i||!r&&0!==r)&&(s&&"object"==typeof s||(s=r),r=i),o=s||{},u=void 0===o.flip||o.flip,l=parseInt(o.width,10),f=parseInt(o.height,10),E=o.debugContext,"string"==typeof i&&t.hasTarget(i)&&t.targetPlugin(i,r,o,!0),this.renderToTexture=o.renderToTexture,h(r,"WebGLFramebuffer"))if(T=r,h(o,"HTMLCanvasElement"))r=o;else if(h(o,"WebGLRenderingContext"))r=o.canvas;else if(h(o.canvas,"HTMLCanvasElement"))r=o.canvas;else{if(!h(o.context,"WebGLRenderingContext"))throw new Error("Must provide a canvas with WebGLFramebuffer target");r=o.context.canvas}if(h(r,"HTMLCanvasElement")){if(l=r.width,f=r.height,(!c||c.canvas!==r&&o.allowSecondaryWebGL)&&(y=a(r,{alpha:!0,premultipliedAlpha:!0,preserveDrawingBuffer:!0,stencil:!0,debugContext:E})),y)c&&c!==y?(this.gl=y,this.frameBuffer={frameBuffer:T||null},this.shader=new m(this.gl,C,G),this.model=d(this.gl),this.pixels=null,this.texture=this.gl.createTexture(),this.gl.bindTexture(c.TEXTURE_2D,this.texture),this.gl.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR),this.gl.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR),this.gl.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),this.gl.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE),this.render=this.renderSecondaryWebGL):(this.seriously.primaryTarget||(this.seriously.primaryTarget=this),c||t.attachContext(y),this.render=this.renderWebGL,o.renderToTexture?c&&(this.frameBuffer=new p(c,l,f,!1)):this.frameBuffer={frameBuffer:T||null});else{if(!o.allowSecondaryWebGL&&c&&c.canvas!==r)throw new Error("Only one WebGL target canvas allowed. Set allowSecondaryWebGL option to create secondary context.");this.render=ee,j.log("Unable to create WebGL context.")}x=!0}if(x||t.constructor.forEachTarget(function(e){if(n(e,r,o,!1))return w=e,!1}),!x)throw new Error("Unknown target type");this.target=r,this.transform=null,this.transformDirty=!0,this.flip=u,l&&(this.width=l),f&&(this.height=f),this.uniforms.resolution[0]=this.width,this.uniforms.resolution[1]=this.height,this.auto=void 0!==o.auto?o.auto:t.auto,this.frames=0,this.pub=new v(this),t.addTargetNode(this)}function D(e){let i,r,s;for(s in e.inputs)if(e.inputs.hasOwnProperty(s)){if(e.reserved.indexOf(s)>=0||Object.prototype[s])throw new Error("Reserved input name: "+s);(i=e.inputs[s]).name=s,isNaN(i.min)&&(i.min=-1/0),isNaN(i.max)&&(i.max=1/0),isNaN(i.minCount)&&(i.minCount=-1/0),isNaN(i.maxCount)&&(i.maxCount=1/0),isNaN(i.step)&&(i.step=0),isNaN(i.mod)&&(i.mod=0),"enum"===i.type&&i.options&&t(i.options)&&i.options.length&&(r={},i.options.forEach(function(e,s){let n,o;t(e)?(n=e[0],o=e[1]||n):n=e,"string"==typeof n?n=n.toLowerCase():"number"==typeof n?n=String(n):n||(n=""),r[n]=o,s||(i.firstValue=n)}),i.options=r),"vector"===i.type?i.dimensions<2?i.dimensions=2:i.dimensions>4?i.dimensions=4:!i.dimensions||isNaN(i.dimensions)?i.dimensions=4:i.dimensions=Math.round(i.dimensions):i.dimensions=1,i.shaderDirty=!!i.shaderDirty,"function"!=typeof i.validate&&(i.validate=A.inputValidators[i.type]||function(e){return e}),e.defaultImageInput||"image"!==i.type||(e.defaultImageInput=s)}}function A(t){function i(){let e,t,i,r,s=this.gl;if(this.primaryTarget&&!s){if(t=this.primaryTarget.target,h(t,"WebGLFramebuffer"))return void j.error("Unable to restore target built on WebGLFramebuffer");if(e=a(t,{alpha:!0,premultipliedAlpha:!0,preserveDrawingBuffer:!0,stencil:!0,debugContext:this.primaryTarget.debugContext})){if(e.isContextLost())return void j.error("Unable to restore WebGL Context");for(this.attachContext(e),this.primaryTarget.renderToTexture?this.primaryTarget.frameBuffer=new p(s,this.primaryTarget.width,this.primaryTarget.height,!1):this.primaryTarget.frameBuffer={frameBuffer:null},i=0;i<g.length;i++)(r=g[i]).setDirty(),r.emit("webglcontextrestored");j.log("WebGL context restored")}}}function r(e){let t,i,s=this.gl;for(e&&(j.warn("WebGL context lost"),e.preventDefault()),u&&(Y(u),u=0),n&&n.removeEventListener("webglcontextlost",r.bind(this),!1),t=0;t<S.length;t++)(i=S[t]).gl=null,i.initialized=!1,i.baseShader=null,i.model=null,i.frameBuffer=null,i.texture=null,i.shader&&i.shader.destroy&&(i.shader.destroy(),i.effect.commonShader&&delete this.commonShaders[i.hook]),i.shaderDirty=!0,i.shader=null,i.effect.lostContext&&i.effect.lostContext.call(i),e&&i.emit("webglcontextlost");for(t=0;t<N.length;t++)(i=N[t]).texture=null,i.initialized=!1,i.allowRefresh=!1,e&&i.emit("webglcontextlost");for(t=0;t<_.length;t++)(i=_[t]).frameBuffer=null,i.texture=null,e&&i.emit("webglcontextlost");for(t=0;t<P.length;t++)(i=P[t]).model=!1,i.frameBuffer=null,e&&i.emit("webglcontextlost");this.baseShader&&this.baseShader.destroy&&this.baseShader.destroy(),s&&(s.deleteBuffer(this.rectangleModel.vertex),s.deleteBuffer(this.rectangleModel.texCoord),s.deleteBuffer(this.rectangleModel.index)),this.rectangleModel&&(delete this.rectangleModel.vertex,delete this.rectangleModel.texCoord,delete this.rectangleModel.index),this.rectangleModel=null,this.baseShader=null,this.gl=s=null,n=null}function s(e){let t,i,r=!1;if(u=0,O.length)for(r=!0,t=0;t<O.length;t++)O[t].call(f,e);if(N&&N.length)for(r=!0,t=0;t<N.length;t++)((i=N[t]).dirty||i.checkDirty&&i.checkDirty())&&(i.dirty=!1,i.setDirty());for(t=0;t<P.length;t++)(i=P[t]).auto&&i.dirty&&i.render();if(U.length)for(r=!0,t=0;t<U.length;t++)U[t].call(f);r&&!u&&(u=H(s))}if(window===this||!(this instanceof A)||void 0!==this.id)return new A(t);let n,u,l=++pe,f=this,c=0,g=[],D={},N=[],P=[],_=[],S=[],F={},O=[],U=[],B={},L=!1;this.commonShaders={},this.auto=!1,t=h(t,"HTMLCanvasElement")?{canvas:t}:t||{},this.attachContext=function(e){let t,s,o=this.gl;if(!o)if(e.canvas.addEventListener("webglcontextlost",r.bind(this),!1),e.canvas.addEventListener("webglcontextrestored",i.bind(this),!1),e.isContextLost())j.warn("Unable to attach lost WebGL context. Will try again when context is restored.");else{for(this.gl=o=e,n=e.canvas,this.rectangleModel=d(o),this.baseShader=new m(o,"#define SHADER_NAME seriously.base\n"+C,"#define SHADER_NAME seriously.base\n"+G),t=0;t<S.length;t++)(s=S[t]).gl=o,s.initialize(),s.buildShader();for(t=0;t<N.length;t++)(s=N[t]).initialize();for(t=0;t<P.length;t++)(s=P[t]).model||(s.model=this.rectangleModel,s.shader=this.baseShader)}},this.effect=function(e,t){if(!re[e])throw new Error("Unknown effect: "+e);return new w(this,e,re[e],t).pub},this.source=function(e,t,i){return this.findInputNode(e,t,i).pub},this.transform=function(e,i){let r;if("string"!=typeof e&&(i=e,e=!1),e){if(!se[e])throw new Error("Unknown transform: "+e)}else if(e=t&&t.defaultTransform||"2d",!se[e])throw new Error("No transform specified");return(r=new x(this,e,se[e],i)).pub},this.target=function(e,t,i){let r,s,n;for(e&&"string"==typeof e&&!oe[e]&&(s=te.querySelector(e)),("string"!=typeof e||!t&&0!==t||s)&&(i&&"object"==typeof i||(i=t),t=s||e,e=null),"string"==typeof t&&isNaN(t)&&(t=te.querySelector(t)),n=0;n<P.length;n++)if(r=P[n],(!e||e===r.hook)&&(r.target===t||r.compare&&r.compare(t,i)))return r.pub;return(r=new R(this,e,t,i)).pub},this.aliases=function(){return Object.keys(F)},this.addAlias=function(e,t){F[e]=t},this.removeAlias=function(e){F[e]&&(delete this[e],delete F[e])},this.getNodeId=function(){return c++},this.findInputNode=function(e,t,i){let r,s;if(("string"!=typeof e||!t&&0!==t)&&(i&&"object"==typeof i||(i=t),t=e),"string"==typeof e&&ne[e]||(e=null),t instanceof E||t instanceof w||t instanceof x)r=t;else if(t instanceof T||t instanceof y||t instanceof b){if(!(r=D[t.id]))throw new Error("Cannot connect a foreign node")}else{for("string"==typeof t&&isNaN(t)&&(t=o(t,["canvas","img","video"])),s=0;s<N.length;s++)if(r=N[s],(!e||e===r.hook)&&r.compare&&r.compare(t,i))return r;r=new E(this,e,t,i)}return r},this.addNode=function(e){g.push(e),D[e.id]=e},this.removeNode=function(e){let t=g.indexOf(e);t>=0&&g.splice(t,1),delete D[e.id]},this.addSourceNode=function(e){this.addNode(e),N.push(e),ie[e.hook].push(e),N.length&&!u&&s()},this.removeSourceNode=function(e){let t=N.indexOf(e);t>=0&&N.splice(t,1),(t=ie[e.hook].indexOf(e))>=0&&ie[e.hook].splice(t,1)},this.addEffectNode=function(e){this.addNode(e),S.push(e),ae[e.hook].push(e)},this.removeEffectNode=function(e){let t,i,r;for(t in F)F.hasOwnProperty(t)&&(i=F[t]).node===e&&this.removeAlias(t);(r=S.indexOf(e))>=0&&S.splice(r,1),(r=ae[e.hook].indexOf(e))>=0&&ae[e.hook].splice(r,1)},this.addTransformNode=function(e){this.addNode(e),_.push(e),ue[e.hook].push(e)},this.removeTransformNode=function(e){let t,i,r;for(t in F)F.hasOwnProperty(t)&&(i=F[t]).node===e&&f.removeAlias(t);(r=_.indexOf(e))>=0&&_.splice(r,1),(r=ue[e.hook].indexOf(e))>=0&&ue[e.hook].splice(r,1)},this.addTargetNode=function(e){let t,i=e.target;le&&((t=le.get(i))?A.logger.warn("Target already in use by another instance",i,Object.keys(t).map(function(e){return t[e]})):(t={},le.set(i,t)),t[this.id]=this),g.push(e),D[e.id]=e,P.push(e)},this.removeTargetNode=function(e){let t,s;le&&(delete(t=le.get(e.target))[f.id],Object.keys(t).length||le.delete(e.target)),(s=P.indexOf(e))>=0&&P.splice(s,1),e===this.primaryTarget&&(n.removeEventListener("webglcontextrestored",i.call(this),!1),r.call(this),this.primaryTarget=null)},this.defaults=function(t,i){let r;if(t)if("object"!=typeof t){if(null===i)delete B[t];else if("object"==typeof i)B[t]=e({},i);else if(void 0===i)return B[t]}else for(r in t)t.hasOwnProperty(r)&&this.defaults(r,t[r]);else if(null===t)for(r in B)B.hasOwnProperty(r)&&delete B[r]},this.draw=function(e,t,i,r,s,n){let o,u,a,l,f,c,d,p,m,g=0,y=this.gl,T=s&&s.gl||y;if(T){s?(l=n&&n.width||s.width||T.canvas.width,f=n&&n.height||s.height||T.canvas.height):(l=n&&n.width||T.canvas.width,f=n&&n.height||T.canvas.height),e.use(),T.viewport(0,0,l,f),T.bindFramebuffer(T.FRAMEBUFFER,r),T.enableVertexAttribArray(e.location.position),T.enableVertexAttribArray(e.location.texCoord),t.texCoord&&(T.bindBuffer(T.ARRAY_BUFFER,t.texCoord),T.vertexAttribPointer(e.location.texCoord,t.texCoord.size,T.FLOAT,!1,0,0)),T.bindBuffer(T.ARRAY_BUFFER,t.vertex),T.vertexAttribPointer(e.location.position,t.vertex.size,T.FLOAT,!1,0,0),T.bindBuffer(T.ELEMENT_ARRAY_BUFFER,t.index),n&&n.depth?y.enable(y.DEPTH_TEST):y.disable(y.DEPTH_TEST),n?void 0===n.blend||n.blend?(y.enable(y.BLEND),c=void 0===n.srcRGB?y.ONE:n.srcRGB,p=n.dstRGB||y.ZERO,d=void 0===n.srcAlpha?c:n.srcAlpha,m=void 0===n.dstAlpha?p:n.dstAlpha,y.blendFuncSeparate(c,p,d,m),y.blendEquation(n.blendEquation||y.FUNC_ADD)):y.disable(y.BLEND):(y.enable(y.BLEND),y.blendFunc(y.ONE,y.ZERO),y.blendEquation(y.FUNC_ADD));for(o in i)i.hasOwnProperty(o)&&(u=i[o],(a=e.uniforms[o])&&(h(u,"WebGLTexture")?(T.activeTexture(T.TEXTURE0+g),T.bindTexture(T.TEXTURE_2D,u),a.set(g),g++):u instanceof E||u instanceof w||u instanceof x?u.texture&&(T.activeTexture(T.TEXTURE0+g),T.bindTexture(T.TEXTURE_2D,u.texture),a.set(g),g++):void 0!==u&&null!==u&&a.set(u)));n&&void 0!==n.clear&&!n.clear||(T.clearColor(0,0,0,0),T.clear(T.COLOR_BUFFER_BIT|T.DEPTH_BUFFER_BIT)),T.drawElements(t.mode,t.length,T.UNSIGNED_SHORT,0),y.enable(y.DEPTH_TEST)}},this.initDaemon=function(){u||(u=H(s))},this.go=function(e,t){let i;for("function"==typeof e&&O.indexOf(e)<0&&O.push(e),"function"==typeof t&&U.indexOf(t)<0&&U.push(t),this.auto=!0,i=0;i<P.length;i++)P[i].go();u||!O.length&&!U.length||s()},this.stop=function(){O.length=0,U.length=0,Y(u),u=0},this.render=function(){let e;for(e=0;e<P.length;e++)P[e].render(t)},this.destroy=function(){let e,t,i;for(;g.length;)(t=g[0]).pub.destroy();for(e in this)this.hasOwnProperty(e)&&"isDestroyed"!==e&&"id"!==e&&((i=Object.getOwnPropertyDescriptor(this,e)).get||i.set||"function"!=typeof this[e]?delete this[e]:this[e]=fe);f=null,N=[],P=[],S=[],g=[],O.length=0,U.length=0,Y(u),u=0,L=!0},this.isDestroyed=function(){return L},this.incompatible=function(e){var t,i,r=A.incompatible(e);if(r)return r;if(!e){for(t in ae)if(ae.hasOwnProperty(t)&&ae[t].length&&(i=re[t])&&"function"==typeof i.compatible&&!i.compatible.call(this))return"plugin-"+t;for(t in ie)if(ie.hasOwnProperty(t)&&ie[t].length&&(i=ne[t])&&"function"==typeof i.compatible&&!i.compatible.call(this))return"source-"+t}return!1},this.isNode=function(e){let t;return!(!e||!(t=D[e.id])||t.isDestroyed)},this.isSource=function(e){return this.isNode(e)&&e instanceof y},this.isEffect=function(e){return this.isNode(e)&&e instanceof T},this.isTransform=function(e){return this.isNode(e)&&e instanceof b},this.isTarget=function(e){return this.isNode(e)&&e instanceof v},Object.defineProperties(this,{id:{enumerable:!0,configurable:!0,get:function(){return l}}}),this.defaults(t.defaults)}const N={transparent:[0,0,0,0],black:[0,0,0,1],red:[1,0,0,1],green:[0,128/255,0,1],blue:[0,0,1,1],white:[1,1,1,1],silver:[192/255,192/255,192/255,1],gray:[128/255,128/255,128/255,1],maroon:[128/255,0,0,1],purple:[128/255,0,128/255,1],fuchsia:[1,0,1,1],lime:[0,1,0,1],olive:[128/255,128/255,0,1],yellow:[1,1,0,1],navy:[0,0,128/255,1],teal:[0,128/255,128/255,1],aqua:[0,1,1,1],orange:[1,165/255,0,1]},P=/^(rgb|hsl)a?\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(,\s*(\d+(\.\d*)?)\s*)?\)/i,_=/^#(([0-9a-fA-F]{3,8}))/,S=["x","y","z","w"],F=["r","g","b","a"],O={srcRGB:770,dstRGB:771,srcAlpha:1,dstAlpha:771},U=["MAX_COMBINED_TEXTURE_IMAGE_UNITS","MAX_FRAGMENT_UNIFORM_VECTORS","MAX_TEXTURE_IMAGE_UNITS","MAX_VARYING_VECTORS","MAX_VERTEX_ATTRIBS","MAX_VERTEX_TEXTURE_IMAGE_UNITS","MAX_VERTEX_UNIFORM_VECTORS"],B=/^[\t ]*#define[\t ]+SHADER_NAME\s+([^$\n\r]+)/i,L=["alias","destroy","effect","id","initialize","inputs","isDestroyed","isReady","matte","off","on","readPixels","render","title","update"],M=["alias","destroy","id","inputs","isDestroyed","isReady","off","on","source","title","update"],I=["aliases","defaults","destroy","effect","draw","go","id","incompatible","isDestroyed","isEffect","isNode","isSource","isTarget","isTransform","initDaemon","addAlias","removeAlias","render","source","stop","addNode","removeNode","target","transform","getNodeId","findInputNode","addSourceNode","removeSourceNode","addEffectNode","removeEffectNode","addTransformNode","removeTransformNode","addTargetNode","removeTargetNode","commonShaders","auto","attachContext"],C=["precision mediump float;","attribute vec4 position;","attribute vec2 texCoord;","uniform vec2 resolution;","uniform mat4 transform;","varying vec2 vTexCoord;","void main(void) {","\tvec4 screenPosition = vec4(position.xy * resolution / 2.0, position.z, position.w);","\tscreenPosition = transform * screenPosition;","\tgl_Position.xy = screenPosition.xy * 2.0 / resolution;","\tgl_Position.z = screenPosition.z * 2.0 / (resolution.x / resolution.y);","\tgl_Position.w = screenPosition.w;","\tvTexCoord = texCoord;","}\n"].join("\n"),G=["precision mediump float;","varying vec2 vTexCoord;","uniform sampler2D source;","void main(void) {","\t\tgl_FragColor = texture2D(source, vTexCoord);","}"].join("\n");let k;window.Float32Array&&(k=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]));let z={frustum:function(e,t,i,r,s,n,o){o||(o=z.create());let h=t-e,u=r-i,a=n-s;return o[0]=2*s/h,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=2*s/u,o[6]=0,o[7]=0,o[8]=(t+e)/h,o[9]=(r+i)/u,o[10]=-(n+s)/a,o[11]=-1,o[12]=0,o[13]=0,o[14]=-n*s*2/a,o[15]=0,o},perspective:function(e,t,i,r,s){var n=i*Math.tan(e*Math.PI/360),o=n*t;return z.frustum(-o,o,-n,n,i,r,s)},multiply:function(e,t,i){let r=t[0],s=t[1],n=t[2],o=t[3],h=t[4],u=t[5],a=t[6],l=t[7],f=t[8],c=t[9],d=t[10],p=t[11],m=t[12],g=t[13],y=t[14],E=t[15],T=i[0],w=i[1],b=i[2],x=i[3];return e[0]=T*r+w*h+b*f+x*m,e[1]=T*s+w*u+b*c+x*g,e[2]=T*n+w*a+b*d+x*y,e[3]=T*o+w*l+b*p+x*E,T=i[4],w=i[5],b=i[6],x=i[7],e[4]=T*r+w*h+b*f+x*m,e[5]=T*s+w*u+b*c+x*g,e[6]=T*n+w*a+b*d+x*y,e[7]=T*o+w*l+b*p+x*E,T=i[8],w=i[9],b=i[10],x=i[11],e[8]=T*r+w*h+b*f+x*m,e[9]=T*s+w*u+b*c+x*g,e[10]=T*n+w*a+b*d+x*y,e[11]=T*o+w*l+b*p+x*E,T=i[12],w=i[13],b=i[14],x=i[15],e[12]=T*r+w*h+b*f+x*m,e[13]=T*s+w*u+b*c+x*g,e[14]=T*n+w*a+b*d+x*y,e[15]=T*o+w*l+b*p+x*E,e},identity:function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},copy:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}};const X=window.console,j={log:n("log"),info:n("info"),warn:n("warn"),error:n("error")},W=window.document,V=[],H=function(){let e=0;return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){const i=(new Date).getTime(),r=Math.max(0,16-(i-e)),s=window.setTimeout(function(){t(i+r)},r);return e=i+r,s}}(),Y=window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.oCancelAnimationFrame||window.msCancelAnimationFrame||function(e){window.cancelTimeout(e)};let q;window.addEventListener("message",function(e){e.source===window&&"seriously-timeout-message"===e.data&&(e.stopPropagation(),V.length>0&&V.shift()())},!0);const K=["img","canvas","video"],Z=window.document;p.prototype.resize=function(e,t){const i=this.gl;this.width===e&&this.height===t||(this.width=e,this.height=t,i&&(i.bindTexture(i.TEXTURE_2D,this.texture),i.bindFramebuffer(i.FRAMEBUFFER,this.frameBuffer),i.bindRenderbuffer(i.RENDERBUFFER,this.renderBuffer),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,e,t,0,i.RGBA,i.UNSIGNED_BYTE,null),i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_COMPONENT16,e,t),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,this.texture,0),i.bindTexture(i.TEXTURE_2D,null),i.bindRenderbuffer(i.RENDERBUFFER,null),i.bindFramebuffer(i.FRAMEBUFFER,null)))},p.prototype.destroy=function(){const e=this.gl;e&&(e.deleteFramebuffer(this.frameBuffer),e.deleteRenderbuffer(this.renderBuffer),this.ownTexture&&e.deleteTexture(this.texture)),delete this.frameBuffer,delete this.renderBuffer,delete this.texture,delete this.gl},m.prototype.use=function(){this.gl.useProgram(this.program)},g.prototype.setReady=function(){let e;if(!this.ready&&(this.ready=!0,this.emit("ready"),this.targets))for(e=0;e<this.targets.length;e++)this.targets[e].setReady()},g.prototype.setUnready=function(){let e;if(this.ready&&(this.ready=!1,this.emit("unready"),this.targets))for(e=0;e<this.targets.length;e++)this.targets[e].setUnready()},g.prototype.setDirty=function(){let e;if(!this.dirty&&(this.emit("dirty"),this.dirty=!0,this.targets))for(e=0;e<this.targets.length;e++)this.targets[e].setDirty()},g.prototype.initFrameBuffer=function(e){this.seriously.gl&&(this.frameBuffer=new p(this.seriously.gl,this.width,this.height,e))},g.prototype.readPixels=function(e,t,i,r,s){const n=this.seriously.gl,o=this.gl||n;if(!n)throw new Error("Cannot read pixels until a canvas is connected");if(this.frameBuffer||(this.initFrameBuffer(),this.setDirty()),this.render(),void 0===s)s=new Uint8Array(i*r*4);else if(!h(s,"Uint8Array"))throw new Error("Incompatible array type");return o.bindFramebuffer(n.FRAMEBUFFER,this.frameBuffer.frameBuffer),o.readPixels(e,t,i,r,n.RGBA,n.UNSIGNED_BYTE,s),s},g.prototype.resize=function(){let e,t;this.source?(e=this.source.width,t=this.source.height):this.sources&&this.sources.source?(e=this.sources.source.width,t=this.sources.source.height):this.inputs&&this.inputs.width?(e=this.inputs.width,t=this.inputs.height||e):this.inputs&&this.inputs.height?e=t=this.inputs.height:(e=1,t=1),e=Math.floor(e),t=Math.floor(t),this.width===e&&this.height===t||(this.width=e,this.height=t,this.emit("resize"),this.setDirty()),this.uniforms&&this.uniforms.resolution&&(this.uniforms.resolution[0]=e,this.uniforms.resolution[1]=t),this.frameBuffer&&this.frameBuffer.resize&&this.frameBuffer.resize(e,t)},g.prototype.on=function(e,t){let i,r=-1;e&&"function"==typeof t&&((i=this.listeners[e])?r=i.indexOf(t):i=this.listeners[e]=[],r<0&&i.push(t))},g.prototype.off=function(e,t){let i,r=-1;e&&"function"==typeof t&&(i=this.listeners[e])&&(r=i.indexOf(t))>=0&&i.splice(r,1)},g.prototype.emit=function(e){let t,i=this.listeners[e];if(i&&i.length)for(t=0;t<i.length;t++)u(i[t])},g.prototype.destroy=function(){let e,t;for(t in this.listeners)this.listeners.hasOwnProperty(t)&&delete this.listeners[t];for(e in this.uniforms)this.uniforms.hasOwnProperty(e)&&delete this.uniforms[e];this.targets&&delete this.targets,this.frameBuffer&&this.frameBuffer.destroy&&(this.frameBuffer.destroy(),delete this.frameBuffer),this.seriously.removeNode(this),delete this.seriously,this.isDestroyed=!0};const $=function(){};E.prototype=Object.create(g.prototype),E.prototype.constructor=E,E.prototype.initialize=function(){let e,t=this.seriously.gl;t&&!this.texture&&this.ready&&(e=t.createTexture(),t.bindTexture(t.TEXTURE_2D,e),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.bindTexture(t.TEXTURE_2D,null),this.texture=e,this.initialized=!0,this.allowRefresh=!0,this.setDirty())},E.prototype.initFrameBuffer=function(e){const t=this.seriously.gl;t&&(this.frameBuffer=new p(t,this.width,this.height,{texture:this.texture,useFloat:e}))},E.prototype.addTarget=function(e){let t;for(t=0;t<this.targets.length;t++)if(this.targets[t]===e)return;this.targets.push(e)},E.prototype.removeTarget=function(e){let t=this.targets&&this.targets.indexOf(e);t>=0&&this.targets.splice(t,1)},E.prototype.update=$,E.prototype.resize=function(){let e,t;if(this.uniforms.resolution[0]=this.width,this.uniforms.resolution[1]=this.height,this.framebuffer&&this.framebuffer.resize(this.width,this.height),this.emit("resize"),this.setDirty(),this.targets)for(e=0;e<this.targets.length;e++)(t=this.targets[e]).resize(),t.setTransformDirty&&t.setTransformDirty()},E.prototype.setReady=function(){let e;if(!this.ready&&(this.ready=!0,this.resize(),this.initialize(),this.emit("ready"),this.targets))for(e=0;e<this.targets.length;e++)this.targets[e].setReady()},E.prototype.render=function(){const e=this.seriously.gl;let t=this.source;e&&(t||0===t)&&this.ready&&(this.initialized||this.initialize(),this.allowRefresh&&this.plugin&&this.plugin.render&&(this.dirty||this.checkDirty&&this.checkDirty())&&this.plugin.render.call(this,e,this.seriously.draw,this.seriously.rectangleModel,this.seriously.baseShader)&&(this.dirty=!1,this.emit("render")))},E.prototype.renderImageCanvas=function(){const e=this.seriously.gl;let t=this.source;if(e&&t&&this.ready&&(this.initialized||this.initialize(),this.allowRefresh&&this.dirty)){e.bindTexture(e.TEXTURE_2D,this.texture),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,this.flip),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1);try{return e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),this.dirty=!1,this.emit("render"),!0}catch(e){e.code===window.DOMException.SECURITY_ERR&&(this.allowRefresh=!1,j.error("Unable to access cross-domain image"))}return!1}},E.prototype.destroy=function(){let e,t;for(this.plugin&&this.plugin.destroy&&this.plugin.destroy.call(this),this.seriously.gl&&this.texture&&this.seriously.gl.deleteTexture(this.texture);this.targets.length;)(t=this.targets.pop())&&t.removeSource&&t.removeSource(this);this.seriously.removeSourceNode(this),g.prototype.destroy.call(this);for(e in this)this.hasOwnProperty(e)&&"id"!==e&&"isDestroyed"!==e&&delete this[e]};const J=function(){};w.prototype=Object.create(g.prototype),w.prototype.constructor=w,w.prototype.initialize=function(){this.initialized||(this.baseShader=this.seriously.baseShader,this.shape?this.model=c(this.shape,this.gl):this.model=this.seriously.rectangleModel,"function"==typeof this.effect.initialize?this.effect.initialize.call(this,function(){this.initFrameBuffer(!0)}.bind(this),this.seriously.gl):this.initFrameBuffer(!0),this.frameBuffer&&(this.texture=this.frameBuffer.texture),this.initialized=!0)},w.prototype.resize=function(){let e;for(g.prototype.resize.call(this),this.effect.resize&&this.effect.resize.call(this),e=0;e<this.targets.length;e++)this.targets[e].resize()},w.prototype.updateReady=function(){let e,t,i,r,s,n=!0;r=this.effect;for(i in r.inputs)if(r.inputs.hasOwnProperty(i)&&"image"===(t=this.effect.inputs[i]).type&&(!this.sources[i]||!this.sources[i].ready)&&(!r.requires||r.requires.call(this,i,this.inputs))){n=!1;break}if(this.ready!==n&&(this.ready=n,this.emit(n?"ready":"unready"),s=n?"setReady":"setUnready",this.targets))for(e=0;e<this.targets.length;e++)this.targets[e][s]()},w.prototype.setReady=w.prototype.updateReady,w.prototype.setUnready=w.prototype.updateReady,w.prototype.addTarget=function(e){let t;for(t=0;t<this.targets.length;t++)if(this.targets[t]===e)return;this.targets.push(e)},w.prototype.removeTarget=function(e){let t=this.targets&&this.targets.indexOf(e);t>=0&&this.targets.splice(t,1)},w.prototype.removeSource=function(e){let t,i=e&&e.pub;for(t in this.inputs)!this.inputs.hasOwnProperty(t)||this.inputs[t]!==e&&this.inputs[t]!==i||(this.inputs[t]=null);for(t in this.sources)!this.sources.hasOwnProperty(t)||this.sources[t]!==e&&this.sources[t]!==i||(this.sources[t]=null)},w.prototype.buildShader=function(){function e(e){return B.test(e)?e:"#define SHADER_NAME seriously."+r+"\n"+e}let t,i=this.effect,r=this.hook;this.shaderDirty&&(i.commonShader&&this.seriously.commonShaders[this.hook]?(this.shader||this.seriously.commonShaders[this.hook].count++,this.shader=this.seriously.commonShaders[this.hook].shader):i.shader?(this.shader&&!i.commonShader&&this.shader.destroy(),(t=i.shader.call(this,this.inputs,{vertex:C,fragment:G},this.seriously.constructor.util))instanceof m?this.shader=t:t&&t.vertex&&t.fragment?this.shader=new m(this.seriously.gl,e(t.vertex),e(t.fragment)):this.shader=this.seriously.baseShader,i.commonShader&&(this.seriously.commonShaders[this.hook]={count:1,shader:this.shader})):this.shader=this.seriously.baseShader,this.shaderDirty=!1)},w.prototype.render=function(){let e,t,i,r=this.effect,s=this;if(this.seriously.gl){if(this.initialized||this.initialize(),this.shaderDirty&&this.buildShader(),this.dirty&&this.ready){for(e in this.sources)!this.sources.hasOwnProperty(e)||r.requires&&!r.requires.call(this,e,this.inputs)||(i="function"==typeof this.inPlace?this.inPlace(e):this.inPlace,this.sources[e].render(!i));this.frameBuffer&&(t=this.frameBuffer.frameBuffer),"function"==typeof r.draw?(r.draw.call(this,this.shader,this.model,this.uniforms,t,function(e,t,i,r,n,o){s.seriously.draw(e,t,i,r,n||s,o)}),this.emit("render")):t&&(this.seriously.draw(this.shader,this.model,this.uniforms,t,this),this.emit("render")),this.dirty=!1}return this.texture}},w.prototype.setInput=function(e,t){let i,r,s,n,o,h=this;if(this.effect.inputs.hasOwnProperty(e)){if("image"===(i=this.effect.inputs[e]).type){if(t){if((t=this.seriously.findInputNode(t))!==this.sources[e]){if(function(){let t,i=h.sources[e];if(i){for(t in h.sources)if(t!==e&&h.sources.hasOwnProperty(t)&&h.sources[t]===i)return;i.removeTarget(h)}}(),this.seriously.constructor.traceSources(t,this))throw new Error("Attempt to make cyclical connection.");this.sources[e]=t,t.addTarget(this)}}else delete this.sources[e],t=!1;r=this.sources[e],s=Object.keys(this.sources),!0===this.inPlace&&1===s.length?(n=this.sources[s[0]],this.uniforms.transform=n&&n.cumulativeMatrix||k):this.uniforms.transform=k}else{let s=this.seriously.defaults(this.hook);o=s&&void 0!==s[e]?s[e]:i.defaultValue,r=t=i.validate.call(this,t,i,o,this.inputs[e])}return this.inputs[e]===t&&"color"!==i.type&&"vector"!==i.type?t:(this.inputs[e]=t,i.uniform&&(this.uniforms[i.uniform]=r),"image"===i.type?(this.resize(),this.updateReady()):i.updateSources&&this.updateReady(),i.shaderDirty&&(this.shaderDirty=!0),this.setDirty(),i.update&&i.update.call(this,t),t)}},w.prototype.alias=function(e,t){const i=this;if(I.indexOf(t)>=0)throw new Error("'"+t+"' is a reserved name and cannot be used as an alias.");return this.effect.inputs.hasOwnProperty(e)&&(t||(t=e),this.seriously.removeAlias(t),this.seriously.addAlias(t,{node:this,input:e}),Object.defineProperty(this.seriously,t,{configurable:!0,enumerable:!0,get:function(){return i.inputs[e]},set:function(t){return i.setInput(e,t)}})),this},w.prototype.matte=function(e){function t(e,t,i,r){const s=(r.x-i.x)*(e.y-i.y)-(r.y-i.y)*(e.x-i.x),n=(t.x-e.x)*(e.y-i.y)-(t.y-e.y)*(e.x-i.x),o=(r.y-i.y)*(t.x-e.x)-(r.x-i.x)*(t.y-e.y);if(o){let i=s/o,r=n/o;if(i>0&&i<=1&&r>0&&r<=1)return{x:e.x+i*(t.x-e.x),y:e.y+i*(t.y-e.y)}}return!1}let i,r,s,n,o,h,u,a=[],l=[],f={};for(i=function(e){return e&&e.length&&Array.isArray(e)?Array.isArray(e[0])?Array.isArray(e[0])&&!isNaN(e[0][0])?[e]:e:[e]:[]}(e),s=0;s<i.length;s++){for(e=i[s],u=null,r={vertices:[],edges:[]},n=0;n<e.length;n++)"object"!=typeof(o=e[n])||isNaN(o.x)||isNaN(o.y)?o.length>=2&&!isNaN(o[0])&&!isNaN(o[1])&&(h={x:o[0],y:o[1],id:l.length}):h={x:o.x,y:o.y,id:l.length},h&&(u?(u.next=h,h.prev=u,h.next=r.vertices[0],r.vertices[0].prev=h):(r.head=h,h.next=h,h.prev=h),l.push(h),r.vertices.push(h),u=h);if(r.vertices.length>2)for(3===r.vertices.length&&(r.simple=!0),a.push(r),n=0;n<r.vertices.length;n++)h=r.vertices[n],r.edges.push([h,h.next])}for(s=a.length-1;s>=0;s--)!function(e){let i,r,s,n,o,h,u,f,c,d,p,m=[];if(!e.simple){for(i=0;i<e.edges.length;i++)for(s=e.edges[i],r=i+1;r<e.edges.length;r++)n=e.edges[r],(o=t(s[0],s[1],n[0],n[1]))&&(o.edge1=s,o.edge2=n,m.push(o));if(m.length){for(c=[],i=0;i<m.length;i++)s=(o=m[i]).edge1,n=o.edge2,d={x:o.x,y:o.y,prev:s[0],next:n[1],id:l.length},e.vertices.push(d),l.push(d),p={x:o.x,y:o.y,prev:n[0],next:s[1],id:l.length},e.vertices.push(p),l.push(d),d.prev.next=d,d.next.prev=d,p.prev.next=p,p.next.prev=p;do{h={edges:[],vertices:[],simple:!0},c.push(h),u=f=e.vertices[0];do{i=e.vertices.indexOf(f),e.vertices.splice(i,1),h.edges.push([f,f.next]),h.vertices.push(f),f=f.next}while(f!==u)}while(e.vertices.length);for(i=a.indexOf(e),a.splice(i,1),i=0;i<c.length;i++)a.push(c[i])}else e.simple=!0}}(r=a[s]);for(s=0;s<a.length;s++)(r=a[s]).clockWise=function(e){let t,i,r,s,n=e.vertices.length,o=0;for(t=n-1,i=0;i<n;t=i,i++)r=e.vertices[t],s=e.vertices[i],o+=r.x*s.y-s.x*r.y;return o>0}(r),function(e){function t(e,t,i,r){let s,n,o,h,u,a,l,f,c,d,p,m,g,y,E;return s=i.x-t.x,n=i.y-t.y,o=e.x-i.x,h=e.y-i.y,u=t.x-e.x,a=t.y-e.y,l=r.x-e.x,f=r.y-e.y,c=r.x-t.x,d=r.y-t.y,p=r.x-i.x,m=r.y-i.y,E=s*d-n*c,g=u*f-a*l,y=o*m-h*p,E>=0&&y>=0&&g>=0}let i,s,n,o,h,u,a,l,f,c,d,p=e.vertices,m=[],g=[];if(s=p.length,e.clockWise)for(i=0;i<s;i++)m[i]=i;else for(i=0;i<s;i++)m[i]=s-1-i;for(o=2*(n=s),i=n-1;n>2;){if(o--<=0)return g;if(h=i,n<=h&&(h=0),i=h+1,n<=i&&(i=0),u=i+1,n<u&&(u=0),function(e,i,r,s,n){let o,h,u,a,l;if(h=p[n[e]],u=p[n[i]],a=p[n[r]],0>(u.x-h.x)*(a.y-h.y)-(u.y-h.y)*(a.x-h.x))return!1;for(o=0;o<s;o++)if(o!==e&&o!==i&&o!==r&&(l=p[n[o]],t(h,u,a,l)))return!1;return!0}(h,i,u,n,m)){for(a=m[h],l=m[i],f=m[u],e.clockWise?(g.push(p[a]),g.push(p[l]),g.push(p[f])):(g.push(p[f]),g.push(p[l]),g.push(p[a])),c=i,d=i+1;d<n;c++,d++)m[c]=m[d];o=2*--n}}r.indices=g}(r);for(f.vertices=[],f.coords=[],s=0;s<l.length;s++)o=l[s],f.vertices.push(2*o.x-1),f.vertices.push(-2*o.y+1),f.vertices.push(-1),f.coords.push(o.x),f.coords.push(-1*o.y+1);for(f.vertices=new Float32Array(f.vertices),f.coords=new Float32Array(f.coords),f.indices=[],s=0;s<a.length;s++)for(r=a[s],n=0;n<r.indices.length;n++)o=r.indices[n],f.indices.push(o.id);f.indices=new Uint16Array(f.indices),this.shape=f,this.gl&&c(f,this.gl)},w.prototype.destroy=function(){const e=this.seriously.commonShaders;let t,i,r=this.hook;this.effect.destroy&&"function"==typeof this.effect.destroy&&this.effect.destroy.call(this),delete this.effect,e[r]&&(e[r].count--,e[r].count||delete e[r]),this.shader&&this.shader.destroy&&this.shader!==this.seriously.baseShader&&!e[r]&&this.shader.destroy(),delete this.shader;for(t in this.inputElements)this.inputElements.hasOwnProperty(t)&&((i=this.inputElements[t]).element.removeEventListener("change",i.listener,!0),i.element.removeEventListener("input",i.listener,!0));for(t in this.sources)this.sources.hasOwnProperty(t)&&((i=this.sources[t])&&i.removeTarget&&i.removeTarget(this),delete this.sources[t]);for(;this.targets.length;)(i=this.targets.pop())&&i.removeSource&&i.removeSource(this);this.seriously.removeEffectNode(this),g.prototype.destroy.call(this);for(t in this)this.hasOwnProperty(t)&&"id"!==t&&"isDestroyed"!==t&&delete this[t]};const Q=function(){};x.prototype=Object.create(g.prototype),x.prototype.constructor=x,x.prototype.setDirty=function(){this.renderDirty=!0,g.prototype.setDirty.call(this)},x.prototype.setTransformDirty=function(){let e,t;for(this.transformDirty=!0,this.dirty=!0,this.renderDirty=!0,e=0;e<this.targets.length;e++)(t=this.targets[e]).setTransformDirty?t.setTransformDirty():t.setDirty()},x.prototype.resize=function(){let e;for(g.prototype.resize.call(this),this.plugin.resize&&this.plugin.resize.call(this),e=0;e<this.targets.length;e++)this.targets[e].resize();this.setTransformDirty()},x.prototype.setSource=function(e){let t;if((t=this.seriously.findInputNode(e))!==this.source){if(this.seriously.constructor.traceSources(t,this))throw new Error("Attempt to make cyclical connection.");this.source&&this.source.removeTarget(this),this.source=t,t.addTarget(this),t&&t.ready?this.setReady():this.setUnready(),this.resize()}},x.prototype.addTarget=function(e){let t;for(t=0;t<this.targets.length;t++)if(this.targets[t]===e)return;this.targets.push(e)},x.prototype.removeTarget=function(e){const t=this.targets&&this.targets.indexOf(e);t>=0&&this.targets.splice(t,1),this.targets&&this.targets.length&&this.resize()},x.prototype.setInput=function(e,t){let i,r,s,n=this.seriously.defaults(this.hook);if(this.plugin.inputs.hasOwnProperty(e))return i=this.plugin.inputs[e],r=n&&void 0!==n[e]?n[e]:i.defaultValue,s=i.get.call(this),void 0===r&&(r=s),t=i.validate.call(this,t,i,r,s),i.set.call(this,t)&&this.setTransformDirty(),i.get.call(this)},x.prototype.alias=function(e,t){let i,r,s=this;if(I.indexOf(t)>=0)throw new Error("'"+t+"' is a reserved name and cannot be used as an alias.");return this.plugin.inputs.hasOwnProperty(e)&&(t||(t=e),this.seriously.removeAlias(t),(i=this.inputs[e])?(r=s.inputs[e],Object.defineProperty(this.seriously,t,{configurable:!0,enumerable:!0,get:function(){return r.get.call(s)},set:function(e){r.set.call(s,e)&&s.setTransformDirty()}})):(i=this.methods[e])&&(r=i,this.seriously[t]=function(){r.apply(s,arguments)&&s.setTransformDirty()}),i&&this.seriously.addAlias(t,{node:this,input:e})),this},x.prototype.render=function(e){const t=this.seriously.gl;return this.source?(this.source.render(),this.transformDirty&&(this.transformed?this.source.cumulativeMatrix?z.multiply(this.cumulativeMatrix,this.matrix,this.source.cumulativeMatrix):z.copy(this.cumulativeMatrix,this.matrix):z.copy(this.cumulativeMatrix,this.source.cumulativeMatrix||k),this.transformDirty=!1),e&&t?(this.renderDirty&&(this.frameBuffer||(this.uniforms={resolution:[this.width,this.height]},this.frameBuffer=new p(t,this.width,this.height)),this.uniforms.source=this.source.texture,this.uniforms.transform=this.cumulativeMatrix||k,this.seriously.draw(this.seriously.baseShader,this.seriously.rectangleModel,this.uniforms,this.frameBuffer.frameBuffer,this),this.renderDirty=!1),this.texture=this.frameBuffer.texture):this.source?this.texture=this.source.texture:this.texture=null,this.dirty=!1,this.texture):(this.transformDirty&&(z.copy(this.cumulativeMatrix,this.matrix),this.transformDirty=!1),this.texture=null,void(this.dirty=!1))},x.prototype.readPixels=function(e,t,i,r,s){const n=this.seriously.gl,o=this.gl||n;if(!o)throw new Error("Cannot read pixels until a canvas is connected");if(this.render(!0),void 0===s)s=new Uint8Array(i*r*4);else if(!h(s,"Uint8Array"))throw new Error("Incompatible array type");return o.bindFramebuffer(n.FRAMEBUFFER,this.frameBuffer.frameBuffer),o.readPixels(e,t,i,r,n.RGBA,n.UNSIGNED_BYTE,s),s},x.prototype.destroy=function(){let e,t,i;this.plugin.destroy&&"function"==typeof this.plugin.destroy&&this.plugin.destroy.call(this),delete this.effect,this.frameBuffer&&(this.frameBuffer.destroy(),delete this.frameBuffer,delete this.texture);for(e in this.inputElements)this.inputElements.hasOwnProperty(e)&&((i=this.inputElements[e]).element.removeEventListener("change",i.listener,!0),i.element.removeEventListener("input",i.listener,!0));for(this.source&&this.source.removeTarget(this);this.targets.length;)(i=this.targets.pop())&&i.removeSource&&i.removeSource(this);this.seriously.removeTransformNode(this),g.prototype.destroy.call(this);for(t in this)this.hasOwnProperty(t)&&"id"!==t&&"isDestroyed"!==t&&delete this[t]};const ee=function(){};R.prototype=Object.create(g.prototype),R.prototype.constructor=R,R.prototype.setSource=function(e){let t;(t=this.seriously.findInputNode(e))!==this.source&&(this.source&&this.source.removeTarget(this),this.source=t,t.addTarget(this),t&&(this.resize(),t.ready?this.setReady():this.setUnready()),this.setDirty())},R.prototype.setDirty=function(){this.dirty=!0,this.auto&&this.seriously.initDaemon()},R.prototype.resize=function(){h(this.target,"HTMLCanvasElement")?this.width===this.target.width&&this.height===this.target.height||(this.target.width=this.width,this.target.height=this.height,this.uniforms.resolution[0]=this.width,this.uniforms.resolution[1]=this.height,this.emit("resize"),this.setTransformDirty()):this.plugin&&this.plugin.resize&&this.plugin.resize.call(this),!this.source||this.source.width===this.width&&this.source.height===this.height||this.transform||(this.transform=new Float32Array(16))},R.prototype.setTransformDirty=function(){this.transformDirty=!0,this.setDirty()},R.prototype.go=function(){this.auto=!0,this.setDirty()},R.prototype.stop=function(){this.auto=!1},R.prototype.render=function(){this.seriously.gl&&this.plugin&&this.plugin.render&&this.plugin.render.call(this,this.seriously.draw.bind(this.seriously),this.seriously.baseShader,this.seriously.rectangleModel)},R.prototype.renderWebGL=function(){let e,t,i;if(this.resize(),this.seriously.gl&&this.dirty&&this.ready){if(!this.source)return;this.source.render(),this.uniforms.source=this.source.texture,this.source.width===this.width&&this.source.height===this.height?this.uniforms.transform=this.source.cumulativeMatrix||k:this.transformDirty&&(e=this.transform,z.copy(e,this.source.cumulativeMatrix||k),t=this.source.width/this.width,i=this.source.height/this.height,e[0]*=t,e[1]*=t,e[2]*=t,e[3]*=t,e[4]*=i,e[5]*=i,e[6]*=i,e[7]*=i,this.uniforms.transform=e,this.transformDirty=!1),this.seriously.draw(this.seriously.baseShader,this.seriously.rectangleModel,this.uniforms,this.frameBuffer.frameBuffer,this,O),this.emit("render"),this.dirty=!1}},R.prototype.renderSecondaryWebGL=function(){let e,t,i,r,s;this.gl;this.dirty&&this.ready&&this.source&&(this.emit("render"),this.source.render(!0),e=this.source.width,t=this.source.height,this.pixels&&this.pixels.length===e*t*4||(this.pixels=new Uint8Array(e*t*4)),this.source.readPixels(0,0,e,t,this.pixels),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,e,t,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.pixels),e===this.width&&t===this.height?this.uniforms.transform=k:this.transformDirty&&(i=this.transform,z.copy(i,k),r=this.source.width/this.width,s=this.source.height/this.height,i[0]*=r,i[1]*=r,i[2]*=r,i[3]*=r,i[4]*=s,i[5]*=s,i[6]*=s,i[7]*=s,this.uniforms.transform=i,this.transformDirty=!1),this.uniforms.source=this.texture,this.seriously.draw(this.shader,this.model,this.uniforms,null,this,O),this.dirty=!1)},R.prototype.removeSource=function(e){this.source!==e&&this.source!==e.pub||(this.source=null)},R.prototype.destroy=function(){this.source&&this.source.removeTarget&&this.source.removeTarget(this),this.seriously.removeTargetNode(this),this.plugin&&this.plugin.destroy&&this.plugin.destroy.call(this),delete this.source,delete this.target,delete this.pub,delete this.uniforms,delete this.pixels,delete this.auto,g.prototype.destroy.call(this)};const te=window.document,ie={canvas:[],image:[],video:[]},re={},se={},ne={},oe={},he={},ue={},ae={},le=window.WeakMap&&new WeakMap,fe=function(){};let ce,de,pe=0;return A.traceSources=function e(t,i){let r,s,n;if(!(t instanceof w||t instanceof x))return!1;if(t===i)return!0;n=t.sources;for(r in n)if(n.hasOwnProperty(r)&&((s=n[r])===i||e(s,i)))return!0;return!1},A.incompatible=function(e){let t,i,r;if(void 0===de&&((t=te.createElement("canvas"))&&t.getContext?window.WebGLRenderingContext?(i=l(de))||(de="context"):de="webgl":de="canvas"),de)return de;if(e){if((r=re[e])&&"function"==typeof r.compatible&&!r.compatible(i))return"plugin-"+e;if((r=ne[e])&&"function"==typeof r.compatible&&!r.compatible(i))return"source-"+e}return!1},A.plugin=function(t,i,r){let s;if(re[t])A.logger.warn("Effect ["+t+"] already loaded");else if(void 0===r&&"object"==typeof i&&(r=i),r)return s=e({},r),"function"==typeof i&&(s.definition=i),s.reserved=L,s.inputs&&D(s),s.title||(s.title=t),re[t]=s,ae[t]=[],s},A.removePlugin=function(e){let t,i,r;if(!e)return this;if(!(r=re[e]))return this;if(t=ae[e]){for(;t.length;)(i=t.shift()).destroy();delete ae[e]}return delete re[e],this},A.source=function(t,i,r){let s;if(ne[t])A.logger.warn("Source ["+t+"] already loaded");else if(void 0===r&&"object"==typeof i&&(r=i),r||i)return s=e({},r),"function"==typeof i&&(s.definition=i),s.title||(s.title=t),ne[t]=s,ie[t]=[],s},A.removeSource=function(e){let t,i,r;if(!e)return this;if(!(r=ne[e]))return this;if(t=ie[e]){for(;t.length;)(i=t.shift()).destroy();delete ie[e]}return delete ne[e],this},A.transform=function(t,i,r){let s;if(se[t])A.logger.warn("Transform ["+t+"] already loaded");else if(void 0===r&&"object"==typeof i&&(r=i),r||i)return s=e({},r),"function"==typeof i&&(s.definition=i),s.reserved=M,s.inputs&&D(s),s.title||(s.title=t),se[t]=s,ue[t]=[],s},A.removeTransform=function(e){let t,i,r;if(!e)return this;if(!(r=se[e]))return this;if(t=ue[e]){for(;t.length;)(i=t.shift()).destroy();delete ue[e]}return delete se[e],this},A.target=function(t,i,r){let s;if(oe[t])A.logger.warn("Target ["+t+"] already loaded");else if(void 0===r&&"object"==typeof i&&(r=i),r||i)return s=e({},r),"function"==typeof i&&(s.definition=i),s.title||(s.title=t),oe[t]=s,he[t]=[],s},A.removeTarget=function(e){let t,i,r;if(!e)return this;if(!(r=oe[e]))return this;if(t=he[e]){for(;t.length;)(i=t.shift()).destroy();delete he[e]}return delete oe[e],this},A.sourcePlugin=function(t,i,r,s,n){let o=ne[i];if(o&&o.definition){if(!(o=o.definition.call(t,r,s,n)))return null;o=e(e({},ne[i]),o)}return o},A.getTarget=function(e){return oe[e]},A.forEachSource=function(e){for(let t in ne)if(ne.hasOwnProperty(t)&&ne[t]&&!1===e(t,ne[t]))break},A.forEachTarget=function(e){for(let t in oe)if(oe.hasOwnProperty(t)&&oe[t]&&!1===e(t,ne[t]))break},A.inputValidators={color:function(e,r,s,n){var o,h,u,a;if(h=n||[],"string"==typeof e){if((u=P.exec(e))&&u.length){if(u.length<3)return h[0]=h[1]=h[2]=h[3]=0,h;for(h[3]=1,a=0;a<3;a++)h[a]=parseFloat(u[a+2])/255;return isNaN(u[6])||(h[3]=parseFloat(u[6])),"hsl"===u[1].toLowerCase()?i(h[0],h[1],h[2],h[3],h):h}if((u=_.exec(e))&&u.length)return 3===(o=u[1]).length?(h[0]=parseInt(o[0],16)/15,h[1]=parseInt(o[1],16)/15,h[2]=parseInt(o[2],16)/15,h[3]=1):4===o.length?(h[0]=parseInt(o[0],16)/15,h[1]=parseInt(o[1],16)/15,h[2]=parseInt(o[2],16)/15,h[3]=parseInt(o[3],16)/15):6===o.length?(h[0]=parseInt(o.substr(0,2),16)/255,h[1]=parseInt(o.substr(2,2),16)/255,h[2]=parseInt(o.substr(4,2),16)/255,h[3]=1):8===o.length?(h[0]=parseInt(o.substr(0,2),16)/255,h[1]=parseInt(o.substr(2,2),16)/255,h[2]=parseInt(o.substr(4,2),16)/255,h[3]=parseInt(o.substr(6,2),16)/255):h[0]=h[1]=h[2]=h[3]=0,h;if(u=N[e.toLowerCase()]){for(a=0;a<4;a++)h[a]=u[a];return h}return ce||(ce=te.createElement("canvas").getContext("2d")),ce.fillStyle=e,(o=ce.fillStyle)&&"#000000"!==o?A.inputValidators.color(o,r,s,n):(h[0]=h[1]=h[2]=h[3]=0,h)}if(t(e)){if((h=e).length<3)return h[0]=h[1]=h[2]=h[3]=0,h;for(a=0;a<3;a++)if(isNaN(h[a]))return h[0]=h[1]=h[2]=h[3]=0,h;return h.length<4&&h.push(1),h}if("number"==typeof e)return h[0]=h[1]=h[2]=e,h[3]=1,h;if("object"==typeof e){for(a=0;a<4;a++)null===e[o=F[a]]||isNaN(e[o])?h[a]=3===a?1:0:h[a]=e[o];return h}return h[0]=h[1]=h[2]=h[3]=0,h},number:function(e,t,i){return e=parseFloat(e),isNaN(e)?i||0:(t.mod&&(e-=t.mod*Math.floor(e/t.mod)),e<t.min?t.min:e>t.max?t.max:t.step?Math.round(e/t.step)*t.step:e)},enum:function(e,t,i){let r=t.options||[];return"string"==typeof e?e=e.toLowerCase():"number"==typeof e?e=e.toString():e||(e=""),r.hasOwnProperty(e)?e:i||""},vector:function(e,i,r,s){let n,o,h,u=i.dimensions||4;if(n=s||[],t(e)){for(o=0;o<u;o++)n[o]=e[o]||0;return n}if("object"==typeof e){for(o=0;o<u;o++)void 0===e[h=S[o]]&&(h=F[o]),n[o]=e[h]||0;return n}for(e=parseFloat(e)||0,o=0;o<u;o++)n[o]=e;return n},boolean:function(e){return!!e&&(!e||!e.toLowerCase||"false"!==e.toLowerCase())},string:function(e){return"string"==typeof e?e:0===e||e?e.toString?e.toString():String(e):""}},A.validateInputSpecs=D,A.prototype.effects=A.effects=function(){let e,t,i,r,s,n={};for(e in re)if(re.hasOwnProperty(e)){i={title:(t=re[e]).title||e,description:t.description||"",inputs:{}};for(s in t.inputs)t.inputs.hasOwnProperty(s)&&(r=t.inputs[s],i.inputs[s]={type:r.type,defaultValue:r.defaultValue,step:r.step,min:r.min,max:r.max,mod:r.mod,minCount:r.minCount,maxCount:r.maxCount,dimensions:r.dimensions,title:r.title||s,description:r.description||"",options:r.options||[]});n[e]=i}return n},A.prototype.getTarget=function(e){return oe[e]},A.prototype.hasTarget=function(e){return!!oe[e]},window.Seriously&&"object"==typeof window.Seriously&&function(){let e;for(e in window.Seriously)window.Seriously.hasOwnProperty(e)&&"plugin"!==e&&"object"==typeof window.Seriously[e]&&A.plugin(e,window.Seriously[e])}(),A.logger=j,A.util={mat4:z,checkSource:function(e){return f(e,de)},hslToRgb:i,colors:N,setTimeoutZero:u,ShaderProgram:m,FrameBuffer:p,requestAnimationFrame:H},A.plugin("sepia",{commonShader:!0,shader:function(e,t){return t.fragment=["precision mediump float;","varying vec2 vTexCoord;","uniform sampler2D source;","uniform vec4 light;","uniform vec4 dark;","uniform float desat;","uniform float toned;","const mat4 coeff = mat4(0.393, 0.349, 0.272, 1.0,0.796, 0.686, 0.534, 1.0, 0.189, 0.168, 0.131, 1.0, 0.0, 0.0, 0.0, 1.0 );","void main(void) {","\tvec4 sourcePixel = texture2D(source, vTexCoord);","\tgl_FragColor = coeff * sourcePixel;","}"].join("\n"),t},inPlace:!0,inputs:{source:{type:"image",uniform:"source"}},title:"Sepia",description:""}),A.plugin("brightness-contrast",{commonShader:!0,shader:function(e,t){return t.fragment=["precision mediump float;","varying vec2 vTexCoord;","uniform sampler2D source;","uniform float brightness;","uniform float saturation;","uniform float contrast;","const vec3 half3 = vec3(0.5);","void main(void) {","\tvec4 pixel = texture2D(source, vTexCoord);","\tvec3 color = pixel.rgb * brightness;","\tcolor = (color - half3) * contrast + half3;","\tgl_FragColor = vec4(color, pixel.a);","}"].join("\n"),t},inPlace:!0,inputs:{source:{type:"image",uniform:"source"},brightness:{type:"number",uniform:"brightness",defaultValue:1,min:0},contrast:{type:"number",uniform:"contrast",defaultValue:1,min:0}},title:"Brightness/Contrast",description:"Multiply brightness and contrast values. Works the same as CSS filters."}),A.plugin("hue-saturation",{commonShader:!0,shader:function(e,t){return t.vertex=["precision mediump float;","attribute vec4 position;","attribute vec2 texCoord;","uniform vec2 resolution;","uniform mat4 projection;","uniform mat4 transform;","uniform float hue;","uniform float saturation;","varying vec2 vTexCoord;","varying vec3 weights;","void main(void) {","\tfloat angle = hue * 3.14159265358979323846264;","\tfloat s = sin(angle);","\tfloat c = cos(angle);","\tweights = (vec3(2.0 * c, -sqrt(3.0) * s - c, sqrt(3.0) * s - c) + 1.0) / 3.0;","\tvec4 screenPosition = vec4(position.xy * resolution / 2.0, position.z, position.w);","\tscreenPosition = transform * screenPosition;","\tgl_Position = screenPosition;","\tgl_Position.xy = screenPosition.xy * 2.0 / resolution;","\tgl_Position.z = screenPosition.z * 2.0 / (resolution.x / resolution.y);","\tvTexCoord = texCoord;","}"].join("\n"),t.fragment=["precision mediump float;","varying vec2 vTexCoord;","varying vec3 weights;","uniform sampler2D source;","uniform float hue;","uniform float saturation;","void main(void) {","\tvec4 color = texture2D(source, vTexCoord);","\tfloat len = length(color.rgb);","\tcolor.rgb = vec3(dot(color.rgb, weights.xyz), dot(color.rgb, weights.zxy), dot(color.rgb, weights.yzx) );","\tvec3 adjustment = (color.r + color.g + color.b) / 3.0 - color.rgb;","\tif (saturation > 0.0) {","\t\tadjustment *= (1.0 - 1.0 / (1.0 - saturation));","\t} else {","\t\tadjustment *= (-saturation);","\t}","\tcolor.rgb += adjustment;","\tgl_FragColor = color;","}"].join("\n"),t},inPlace:!0,inputs:{source:{type:"image",uniform:"source"},hue:{type:"number",uniform:"hue",defaultValue:.4,min:-1,max:1},saturation:{type:"number",uniform:"saturation",defaultValue:0,min:-1,max:1}},title:"Hue/Saturation",description:"Rotate hue and multiply saturation."}),A});
